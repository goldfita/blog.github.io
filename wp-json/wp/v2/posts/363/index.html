{"id":363,"date":"2023-04-26T17:04:40","date_gmt":"2023-04-26T21:04:40","guid":{"rendered":"https:\/\/blog.signalsguru.net\/?p=363"},"modified":"2023-05-24T19:22:06","modified_gmt":"2023-05-24T23:22:06","slug":"wsl-setup-tips","status":"publish","type":"post","link":"http:\/\/blog.signalsguru.net\/archives\/363","title":{"rendered":"WSL Setup Tips"},"content":{"rendered":"\n<h2 class=\"wp-block-heading\">Ubuntu<\/h2>\n\n\n\n<p>When scripting VM or container images, it&#8217;s easy to inadvertently <mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">rm -rf \/<\/mark>, so it&#8217;s desirable to mount host drives read only. It&#8217;s also nice to have a static IP for accessing your machine. The default WSL2 configuration uses a dynamic IP. It was actually relatively easy, but it did take me a day or so of work. I&#8217;m using the official distro.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code><mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">Distributor ID: Ubuntu\nDescription: Ubuntu 22.04.2 LTS\nRelease: 22.04\nCodename: jammy<\/mark><\/code><\/pre>\n\n\n\n<p>Create a \/etc\/<a href=\"https:\/\/learn.microsoft.com\/en-us\/windows\/wsl\/wsl-config\">wsl.conf<\/a> that uses \/etc\/fstab. This will allow us to custom mount drives however we want. The <mark class=\"has-inline-color has-ast-global-color-0-color\">appendWindowsPath <\/mark>part automatically adds the paths for powershell, ssh, and other standard Windows executables. For this to work, you need to mount drive C. To set a static IP, set <mark class=\"has-inline-color has-ast-global-color-0-color\">generateHosts <\/mark>to false so Windows doesn&#8217;t overwrite the hosts file. I&#8217;ll get to resolv.conf below.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code><mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">&#91;automount]\nenabled = true\nroot = \/mnt\noptions = \"metadata\"\nmountFsTab = true\n\n&#91;network]\ngenerateResolvConf = false\ngenerateHosts = false\nhostname = ubuntu\n\n&#91;interop]\nappendWindowsPath = true\n\n&#91;user]\ndefault = myuser\n\n&#91;boot]\nsystemd = true<\/mark><\/code><\/pre>\n\n\n\n<p>Now create \/etc\/fstab with the directories you want. Because we enabled automount, it will mount C automatically, but it won&#8217;t be read only. The second entry in fstab makes it read only. Note that you can still modify your host machine by running <mark class=\"has-inline-color has-ast-global-color-0-color\">powershell.exe &#8220;command&#8221;<\/mark>, but it&#8217;s a lot harder to damage by accident.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code><mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\"># UNCONFIGURED FSTAB FOR BASE SYSTEM\nC:\/mystuff \/home\/mystuff drvfs defaults,ro 0 0\nC:         \/mnt\/c        drvfs defaults,ro 0 0<\/mark><\/code><\/pre>\n\n\n\n<p>To use a static IP, we&#8217;ll need a <a href=\"https:\/\/superuser.com\/questions\/1582234\/make-ip-address-of-wsl2-static\">virtual network adapter<\/a>. Do the following as admin. The first command will only work once WSL is up and running. You&#8217;ll have to add a rule to the firewall to <a href=\"https:\/\/gist.github.com\/wllmsash\/1636b86eed45e4024fb9b7ecd25378ce\">allow traffic coming from WSL<\/a>. Without this you won&#8217;t even be able to ping the gateway. You may need to <a href=\"https:\/\/serverfault.com\/questions\/838325\/sshd-is-already-running-though-keeps-trying-to-start\">kill and restart sshd<\/a>. Initially I removed the dynamic IP windows attached to the adapter. Don&#8217;t do this. See below.<\/p>\n\n\n\n<pre class=\"wp-block-code scroll\"><code><mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">netsh.exe interface ip add address \"vEthernet (WSL)\" 192.168.2.1 255.255.255.0\nNew-NetFirewallRule -Name 'WSL' -DisplayName 'WSL' -InterfaceAlias 'vEthernet (WSL)' -Direction Inbound -Action Allow<\/mark><\/code><\/pre>\n\n\n\n<p>To temporarily set an IP, execute the following.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code><mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">ip addr add 192.168.2.5\/24 broadcast 192.168.2.255 dev eth0 label eth0:1<\/mark><\/code><\/pre>\n\n\n\n<p>To set it permanently, edit \/etc\/systemd\/network\/10-eth0.network and run <mark class=\"has-inline-color has-ast-global-color-0-color\">systemctl enable systemd-networkd<\/mark>.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code><mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">&#91;Match]\nName=eth0\n\n&#91;Network]\nAddress=192.168.2.5\/24\nGateway=192.168.2.1\nDHCP=no<\/mark><\/code><\/pre>\n\n\n\n<p>I ran into an issue at this point with contacting the default nameserver. To fix this, you have to set <mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">generateResolvConf<\/mark> to false and add the following to \/etc\/systemd\/resolved.conf. After reboot, check the result with <mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">resolvectl<\/mark>. Initially I tried this with the resolvconf package. But I had to run <mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">resolvconf -u<\/mark> after each boot to get it to generate resolv.conf.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code><mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">&#91;Resolve]\n# Google's public DNS\nDNS=8.8.8.8 8.8.4.4<\/mark><\/code><\/pre>\n\n\n\n<p>You need to link \/etc\/resolve.conf to systemd&#8217;s version.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code><mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">ln -s \/run\/systemd\/resolve\/resolv.conf \/etc\/resolv.conf<\/mark><\/code><\/pre>\n\n\n\n<p>Now update \/etc\/hosts with the new IP.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code><mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">192.168.2.5 ubuntu<\/mark><\/code><\/pre>\n\n\n\n<p>Let yourself log in without a password. You can log in with a different user with the <mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">-u<\/mark> flag (e.g. <mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">wsl -d ubuntu -u myuser<\/mark>).<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code><mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">echo \"myuser ALL=(ALL) NOPASSWD:ALL\" | sudo tee \/etc\/sudoers.d\/myuser<\/mark><\/code><\/pre>\n\n\n\n<p>Unlike VirtualBox virtual hard disks, containers grow automatically. If they get too big, you can shrink them with <a href=\"https:\/\/writeabout.net\/2021\/10\/14\/shrink-your-wsl2-virtual-disk-on-windows-home\/\">diskpart<\/a>. You will need to <a href=\"https:\/\/askubuntu.com\/questions\/1380253\/where-is-wsl-located-on-my-computer\">locate the container image<\/a>.<\/p>\n\n\n\n<p>If you see error messages like the following, something went wrong mapping the drives, and there&#8217;s probably other issues as well. It may crash after a short while. Usually this happens if I shutdown from within the container instead of using <mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">wsl &#8211;shutdown<\/mark>. The only thing to do is restart.<\/p>\n\n\n\n<pre class=\"wp-block-code scroll\"><code><mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">&lt;3>WSL (819) ERROR: UtilTranslatePathList:2803: Failed to translate C:\\Windows\\system32<\/mark><\/code><\/pre>\n\n\n\n<p>If you get error messages about insufficient memory, you can try adding the following to C:\\Users\\myuser.wslconfig.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code><mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">&#91;wsl2]\nmemory=4GB\nprocessors=4<\/mark><\/code><\/pre>\n\n\n\n<h2 class=\"wp-block-heading\">Rocky<\/h2>\n\n\n\n<p>I&#8217;ve create an ansible script to do this for Rocky Linux 9. Download <a href=\"https:\/\/download.rockylinux.org\/pub\/rocky\/9\/images\/x86_64\/\">Rocky-9-container-Base<\/a>. Place the files below in a directory on the host and follow the steps at the top of the YAML file, making sure to change IPs, user names, paths, etc.<\/p>\n\n\n\n<p><a href=\"https:\/\/blog.signalsguru.net\/wp-content\/uploads\/2023\/05\/playbook-wsl.yml\">playbook-wsl.yml<\/a><br><a href=\"https:\/\/blog.signalsguru.net\/wp-content\/uploads\/2023\/05\/fstab.j2\">fstab.j2<\/a><br><a href=\"https:\/\/blog.signalsguru.net\/wp-content\/uploads\/2023\/05\/wsl.conf.j2\">wsl.conf.j2<\/a><br><a href=\"https:\/\/blog.signalsguru.net\/wp-content\/uploads\/2023\/05\/update-ip.sh.j2\">update-ip.sh.j2<\/a><\/p>\n\n\n\n<h3 class=\"wp-block-heading\">Add WSL Network Adapter<\/h3>\n\n\n\n<p>The <mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">vEthernet (WSL)<\/mark> adapter does not get created until you start WSL after each reboot. There are a couple of ways to automate this.<\/p>\n\n\n\n<h6 class=\"wp-block-heading\">Method 1: Startup<\/h6>\n\n\n\n<p>Put the <a href=\"https:\/\/blog.signalsguru.net\/wp-content\/uploads\/2023\/05\/create_wsl_network.bat\">create_wsl_network.bat<\/a> file in a convenient place like your user home. Create a shortcut to the batch file in the same directory. Right click the shortcut, select <strong>Properties -&gt; Advanced<\/strong>, and check <strong>Run as administrator<\/strong>. Type <strong>windows key + R<\/strong> and enter <strong>shell:startup<\/strong>. Create a batch file with a single line that has the full path to the shortcut (e.g. C:\\Users\\myuser\\WSL_Network.lnk). Don&#8217;t ask me why this has to be so complicated. The only problem with doing it this way is that it will ask you for permission to run the batch file every time you log in.<\/p>\n\n\n\n<h6 class=\"wp-block-heading\">Method 2: Task Scheduler<\/h6>\n\n\n\n<p>Start the task scheduler and select <strong>Create Task<\/strong>. Check <strong>Run with highest privileges<\/strong> on the <strong>General <\/strong>tab and enter a name for the task at the top. Under the <strong>Triggers <\/strong>tab, click <strong>New<\/strong>, and select <strong>At log on<\/strong> from the drop down at the top. On the <strong>Actions <\/strong>tab, click <strong>New<\/strong>, and browse to <mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">create_wsl_network.bat<\/mark>. Save.<\/p>\n\n\n\n<h3 class=\"wp-block-heading\">Windows Terminal<\/h3>\n\n\n\n<p>If you&#8217;re using Windows Terminal, you can open a tab directly to a WSL instance.  However, there are a lot of profiles in the dropdown. You can hide a profile by going to <strong>Settings -&gt;  Profiles -&gt; Specific Profile -&gt; Hide profile from dropdown<\/strong>. If you want to save your terminal settings, you can find the <mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">settings.json<\/mark> in C:\\Users\\username\\AppData\\Local\\Packages\\Microsoft.WindowsTerminal_8wekyb3d8bbwe\\LocalState.<\/p>\n\n\n\n<p>Your WSL instances are mounted as network drives. To access an instance called <strong>rocky <\/strong>from Powershell, for example, <mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">cd \\\\wsl.localhost\\rocky<\/mark>.<\/p>\n\n\n\n<h3 class=\"wp-block-heading\">Hyper-V Service<\/h3>\n\n\n\n<p>You may also want to set the <strong>Hyper-V Host Compute Service<\/strong> to start automatically. It isn&#8217;t necessary though since it will start when you start WSL.<\/p>\n\n\n\n<h3 class=\"wp-block-heading\">Shortcut to WSL2 GUI Application<\/h3>\n\n\n\n<p>Create a new shortcut, e.g.:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code><mark style=\"background-color:rgba(0, 0, 0, 0)\" class=\"has-inline-color has-ast-global-color-0-color\">C:\\Windows\\System32\\wsl.exe -d rocky -e bash -ic \"nohup ~\/run-emacs.sh &amp;\"<\/mark><\/code><\/pre>\n","protected":false},"excerpt":{"rendered":"<p>Ubuntu When scripting VM or container images, it&#8217;s easy to inadvertently rm -rf \/, so it&#8217;s desirable to mount host drives read only. It&#8217;s also nice to have a static IP for accessing your machine. The default WSL2 configuration uses a dynamic IP. It was actually relatively easy, but it did take me a day &hellip;<\/p>\n<p class=\"read-more\"> <a class=\"\" href=\"http:\/\/blog.signalsguru.net\/archives\/363\"> <span class=\"screen-reader-text\">WSL Setup Tips<\/span> Read More &raquo;<\/a><\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"site-sidebar-layout":"default","site-content-layout":"default","ast-global-header-display":"","ast-main-header-display":"","ast-hfb-above-header-display":"","ast-hfb-below-header-display":"","ast-hfb-mobile-header-display":"","site-post-title":"","ast-breadcrumbs-content":"","ast-featured-img":"","footer-sml-layout":"","theme-transparent-header-meta":"default","adv-header-id-meta":"","stick-header-meta":"","header-above-stick-meta":"","header-main-stick-meta":"","header-below-stick-meta":"","footnotes":""},"categories":[12],"tags":[],"_links":{"self":[{"href":"http:\/\/blog.signalsguru.net\/wp-json\/wp\/v2\/posts\/363"}],"collection":[{"href":"http:\/\/blog.signalsguru.net\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/blog.signalsguru.net\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/blog.signalsguru.net\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"http:\/\/blog.signalsguru.net\/wp-json\/wp\/v2\/comments?post=363"}],"version-history":[{"count":8,"href":"http:\/\/blog.signalsguru.net\/wp-json\/wp\/v2\/posts\/363\/revisions"}],"predecessor-version":[{"id":397,"href":"http:\/\/blog.signalsguru.net\/wp-json\/wp\/v2\/posts\/363\/revisions\/397"}],"wp:attachment":[{"href":"http:\/\/blog.signalsguru.net\/wp-json\/wp\/v2\/media?parent=363"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/blog.signalsguru.net\/wp-json\/wp\/v2\/categories?post=363"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/blog.signalsguru.net\/wp-json\/wp\/v2\/tags?post=363"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}